<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISTU Flashcard Generator - AI Powered Spaced Repetition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [x-cloak] { display: none !important; }
        body { background: #f8fafc; }
        .card-container { perspective: 1000px; }
        .card-inner {
            transform-style: preserve-3d;
            transition: transform 0.6s;
            position: relative;
            width: 100%;
            height: 100%;
        }
        .rotate-y-180 { transform: rotateY(180deg); }
        .front-content, .back-content { 
            backface-visibility: hidden; 
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
            top: 0;
            left: 0;
        }
        .back-content { transform: rotateY(180deg); }
        #app-content { min-height: calc(100vh - 80px); }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</head>

<body x-data="{
    lang: localStorage.getItem('istu_lang') || 'vi',
    view: 'dashboard',
    loading: false,
    decks: JSON.parse(localStorage.getItem('istu_decks') || '[]'),
    topicInput: '',
    fileInput: '',
    deckTitle: '',
    createMode: 'topic',
    currentDeck: null,
    
    // PROXY URL
    PROXY_API_URL: 'https://istu-api-proxy-c3kkj5uua-thanhcutis-projects.vercel.app/api/generate',

    translations: {
        en: {
            btn_new: 'Create New Deck',
            header_dashboard: 'Your Flashcard Decks',
            header_create: 'Generate New Flashcards with AI',
            tab_topic: 'From Topic',
            tab_file: 'From Text/File',
            label_topic: 'Topic/Concept',
            topic_placeholder: 'E.g., Spaced Repetition Algorithm',
            label_file: 'Paste Text Content',
            file_placeholder: 'Paste your notes, article, or lesson text here (max ~25,000 chars)',
            label_deck_title: 'Deck Title',
            title_placeholder: 'E.g., IT Midterm Review',
            btn_generate: 'Generate Flashcards',
            btn_loading: 'Generating...',
            btn_back: 'Back to Decks',
            label_cards: 'Cards',
            label_source: 'Source',
            label_front: 'Front (Question)',
            label_back: 'Back (Answer)',
            empty_title: 'No Flashcard Decks Yet',
            empty_subtitle: 'Get started by creating a new deck from a topic or text.',
            error_context: 'Please provide a topic or text to generate flashcards.',
            error_api: 'API Proxy Error: Could not reach the server or API key is invalid on server.',
            title: 'ISTU Flashcard Generator'
        },
        vi: {
            btn_new: 'Tạo Bộ Thẻ Mới',
            header_dashboard: 'Các Bộ Thẻ Của Bạn',
            header_create: 'Tạo Thẻ Ghi Nhớ Bằng AI',
            tab_topic: 'Từ Chủ Đề',
            tab_file: 'Từ Văn Bản/File',
            label_topic: 'Chủ Đề/Khái Niệm',
            topic_placeholder: 'Ví dụ: Thuật toán Lặp lại Ngắt quãng (Spaced Repetition)',
            label_file: 'Dán Nội Dung Văn Bản',
            file_placeholder: 'Dán ghi chú, bài báo, hoặc nội dung bài học vào đây (tối đa ~25,000 ký tự)',
            label_deck_title: 'Tiêu Đề Bộ Thẻ',
            title_placeholder: 'Ví dụ: Ôn tập Giữa kỳ Tin học',
            btn_generate: 'Tạo Thẻ Ghi Nhớ',
            btn_loading: 'Đang tạo...',
            btn_back: 'Quay lại',
            label_cards: 'Thẻ',
            label_source: 'Nguồn',
            label_front: 'Mặt trước (Câu hỏi)',
            label_back: 'Mặt sau (Trả lời)',
            empty_title: 'Chưa có Bộ Thẻ nào',
            empty_subtitle: 'Hãy bắt đầu bằng cách tạo một bộ thẻ mới từ chủ đề hoặc văn bản.',
            error_context: 'Vui lòng cung cấp chủ đề hoặc văn bản để tạo thẻ.',
            error_api: 'Lỗi Proxy API: Không thể kết nối đến máy chủ hoặc Key API trên máy chủ không hợp lệ.',
            title: 'ISTU - Công cụ Tạo Thẻ Ghi Nhớ'
        }
    },

    init() {
        this.updateTitle();
        this.$watch('lang', (newLang) => {
            localStorage.setItem('istu_lang', newLang);
            this.updateTitle();
        });
    },

    t(key) {
        return this.translations[this.lang][key] || this.translations['en'][key];
    },

    updateTitle() {
        document.title = this.t('title');
    },

    formatDate(timestamp) {
        const locale = this.lang === 'vi' ? 'vi-VN' : 'en-US'; 
        return new Date(timestamp).toLocaleDateString(locale, { year: 'numeric', month: 'short', day: 'numeric' });
    },

    async handleGenerate() {
        const context = this.createMode === 'topic' ? this.topicInput : this.fileInput;
        const isFile = this.createMode === 'file';

        if (!context.trim()) {
            return alert(this.t('error_context'));
        }

        this.loading = true;
        this.deckTitle = this.deckTitle.trim() || (isFile ? context.substring(0, 50) + '...' : context);

        try {
            const response = await fetch(this.PROXY_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ context: context, isFile: isFile, lang: this.lang }),
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Proxy Call Failed: ${errorText}`);
            }
            
            const cards = await response.json();

            const newDeck = {
                id: Date.now(),
                title: this.deckTitle,
                context: context,
                createdAt: Date.now(),
                cards: cards.map(card => ({ ...card, flipped: false, mastery: 0, nextReview: Date.now() }))
            };

            this.decks.unshift(newDeck);
            localStorage.setItem('istu_decks', JSON.stringify(this.decks));
            
            this.topicInput = '';
            this.fileInput = '';
            this.deckTitle = '';
            this.openDeck(newDeck);

        } catch (error) {
            console.error('Generation Error:', error);
            alert(`${this.t('error_api')}\nDetails: ${error.message}`);
        } finally {
            this.loading = false;
        }
    },

    openDeck(deck) {
        this.currentDeck = deck;
        this.view = 'deckDetail';
    },

    deleteDeck(id) {
        if (confirm(this.lang === 'en' ? 'Are you sure you want to delete this deck?' : 'Bạn có chắc chắn muốn xóa bộ thẻ này không?')) {
            this.decks = this.decks.filter(deck => deck.id !== id);
            localStorage.setItem('istu_decks', JSON.stringify(this.decks));
        }
    }
}" :lang="lang">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="font-bold text-2xl bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 tracking-tight cursor-pointer flex items-center gap-2" @click="view = 'dashboard'">
                <span class="text-3xl">✨</span> 
                <span>ISTU</span>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <button @click="lang = 'vi'; updateTitle()" :class="lang === 'vi' ? 'font-bold text-indigo-600' : 'text-gray-500 hover:text-indigo-600'">VI</button>
                    <span>|</span>
                    <button @click="lang = 'en'; updateTitle()" :class="lang === 'en' ? 'font-bold text-indigo-600' : 'text-gray-500 hover:text-indigo-600'">EN</button>
                </div>
                <button @click="view = 'create'" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition shadow-sm" x-text="t('btn_new')"></button>
            </div>
        </div>
    </nav>
    
    <div id="app-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div x-show="view === 'dashboard'" x-cloak>
            <h1 class="text-3xl font-extrabold text-gray-900 mb-6" x-text="t('header_dashboard')"></h1>
            
            <div x-show="decks.length > 0" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <template x-for="deck in decks" :key="deck.id">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition flex flex-col justify-between cursor-pointer" @click="openDeck(deck)">
                        <div>
                            <p class="text-xs font-bold text-indigo-600 mb-1 uppercase" x-text="deck.cards.length + ' ' + t('label_cards')"></p>
                            <h2 class="text-xl font-bold text-gray-800 mb-3 line-clamp-2" x-text="deck.title"></h2>
                            <p class="text-sm text-gray-500 line-clamp-2" x-text="t('label_source') + ': ' + deck.context"></p>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center text-sm text-gray-500">
                            <span x-text="formatDate(deck.createdAt)"></span>
                            <button @click.stop="deleteDeck(deck.id)" class="text-red-500 hover:text-red-700 ml-4 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="decks.length === 0" class="text-center py-20 bg-white rounded-xl shadow-lg border border-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13M14 5.75c0-1.242 1.503-2.121 2.5-1.75a3.5 3.5 0 013.5 3.5v7.5c0 1.933-1.567 3.5-3.5 3.5H4.25c-1.933 0-3.5-1.567-3.5-3.5v-7.5c0-1.242 1.503-2.121 2.5-1.75a3.5 3.5 0 003.5-3.5V6.253a.75.75 0 011.5 0z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900" x-text="t('empty_title')"></h3>
                <p class="mt-1 text-sm text-gray-500" x-text="t('empty_subtitle')"></p>
                <div class="mt-6">
                    <button @click="view = 'create'" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M11 3a1 1 0 10-2 0v5.586L6.293 6.293a1 1 0 10-1.414 1.414l4 4a1 1 0 001.414 0l4-4a1 1 0 00-1.414-1.414L11 8.586V3zM3 17h14a1 1 0 000-2H3a1 1 0 000 2z" />
                        </svg>
                        <span x-text="t('btn_new')"></span>
                    </button>
                </div>
            </div>
        </div>

        <div x-show="view === 'create'" x-cloak>
            <h1 class="text-3xl font-extrabold text-gray-900 mb-6" x-text="t('header_create')"></h1>
            
            <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100">

                <div class="flex border-b border-gray-200 mb-6">
                    <button @click="createMode = 'topic'" :class="createMode === 'topic' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500'" class="pb-2 px-4 font-bold border-b-2 text-sm transition" x-text="t('tab_topic')"></button>
                    <button @click="createMode = 'file'" :class="createMode === 'file' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500'" class="pb-2 px-4 font-bold border-b-2 text-sm transition" x-text="t('tab_file')"></button>
                </div>
                
                <div x-show="createMode === 'topic'">
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2" x-text="t('label_topic')"></label>
                        <input x-model="topicInput" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-base focus:ring-2 focus:ring-indigo-500 outline-none transition" :placeholder="t('topic_placeholder')">
                    </div>
                </div>

                <div x-show="createMode === 'file'">
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2" x-text="t('label_file')"></label>
                        <textarea x-model="fileInput" rows="10" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-base focus:ring-2 focus:ring-indigo-500 outline-none transition" :placeholder="t('file_placeholder')"></textarea>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2" x-text="t('label_deck_title')"></label>
                    <input x-model="deckTitle" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 text-base focus:ring-2 focus:ring-indigo-500 outline-none transition" :placeholder="t('title_placeholder')">
                </div>

                <button @click="handleGenerate()" :disabled="loading" class="w-full mt-6 bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 disabled:opacity-70 disabled:cursor-not-allowed transition flex justify-center items-center gap-2 shadow-md">
                    <span x-show="loading" class="animate-spin h-5 w-5 border-2 border-white border-opacity-50 rounded-full border-t-transparent"></span>
                    <span x-text="loading ? t('btn_loading') : t('btn_generate')"></span>
                </button>
            </div>
        </div>

        <div x-show="view === 'deckDetail'" x-cloak>
            <button @click="view = 'dashboard'" class="text-indigo-600 hover:text-indigo-800 flex items-center mb-4 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                <span x-text="t('btn_back')"></span>
            </button>

            <template x-if="currentDeck">
                <div>
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-2" x-text="currentDeck.title"></h1>
                    <p class="text-base text-gray-500 mb-6" x-text="t('label_source') + ': ' + currentDeck.context"></p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 card-container">
                        <template x-for="(card, index) in currentDeck.cards" :key="index">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition-shadow duration-500 ease-in-out cursor-pointer relative h-64" 
                                @click="card.flipped = !card.flipped">
                                
                                <div class="card-inner" :class="{ 'rotate-y-180': card.flipped }">
                                    <div class="front-content" x-show="!card.flipped">
                                        <p class="text-sm font-bold text-indigo-600 mb-2" x-text="t('label_front')"></p>
                                        <p class="text-xl font-bold text-gray-900" x-text="card.front"></p>
                                    </div>
                                    
                                    <div class="back-content" x-show="card.flipped">
                                        <p class="text-sm font-bold text-green-600 mb-2" x-text="t('label_back')"></p>
                                        <p class="text-xl text-gray-900" x-text="card.back"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </div>
</body>
</html>